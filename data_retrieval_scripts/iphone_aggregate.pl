#!/usr/bin/perl

use DBI;
use Time::Local;


$age = DBI->connect('DBI:mysql:agentinfo;host=localhost','root','');
$ag="1034854157,1035304579,1039968901,1057541165,1061495119,1061567976,1066220530,1066472668,1093207946,1145052719,1162597358,1163653026,1167723863,1167879036,1183679487,123509,1254382358,1254770075,131515048,1324612708,1330273176,1330451163,1352512735,1354185971,136473,1392110550,1392110758,1392112125,1392169660,1394559056,139574,146022,147571,1526443075,1567962593,1569694875,157700104,1600543988,1601121664,161627,161709,164477908,164486664,1654390616,167286759,172787,172877,1746063906,184246,184943199,1861534450,1868364966,1878041047,1878051971,1878052875,1878057542,1878058290,1878063496,1878071953,1879821619,1880247611,1881981934,1886384826,1886394081,1886442310,1894656149,1894706320,1903020746,1903042431,1911483289,1911552710,1911552871,1919782647,193475,1966492426,1987133047,1990976329,1994949757,2004412586,2004429834,2004478653,2004509242,2004648693,2004670215,2004706539,2004726581,2004780153,2004781101,2004867177,2004869018,2004881125,2004949092,2005095390,2005208423,2005235468,2005259232,2005271798,2005353780,2005354621,2005549044,2005595373,2005761942,2005882187,2005926843,2005978626,2006029124,2006047477,2006068741,2006070707,2006121828,2006189413,2006271388,2006272994,2006365063,2006394885,2006423495,2006476391,2006542153,2006604953,2006718594,2006896403,2007615290,2007665242,2009239953,2009299374,2009311846,2009377979,2009381492,2011691653,2011817768,2012404801,2012509940,2012596130,2012601736,2012961270,2013171289,2013343104,2013611869,2014193153,2016436469,2016836946,2016928453,2017821383,2019472539,2019498715,2019509805,2019542003,2019584348,2020369225,2020898797,2021029139,2021102892,2021872400,2023135806,2023219812,2026157259,2026380819,2026788781,2026816659,2026867383,2026869422,2027429930,2027440490,2027486388,2027590334,2027858796,2028371001,2029349693,2029377452,2030606356,2032730522,2033115247,2035568887,2035759998,2036448178,2036783164,2038272357,2043396736,2044230146,2044836546,2045347168,2046104155,2046717876,2047578882,2048470350,2049057075,2049116185,2049856291,2054198661,2054770147,2057060037,2058470963,2060118183,2060702829,2060861746,2061124872,2062215457,2062221456,2062222077,2063868789,2066180196,207314,2076267608,2076860569,2079509287,2079511900,2081633662,2082137319,2087376322,2088716356,2092902374,2094278182,2097572372,2099662793,2101052522,2102237065,2102862821,2103137488,2108592263,2109562948,2110913491,2112294241,2128389773,2142904745,2144557162,2144741659,2144810084,215097439,219953046,225589881,229094,230482542,242974,243016,257192289,257734193,263035593,264361764,275257,278784,279060,279875,279877,280736,307080,309440,319551,334181,336039,336255,336262,341234,342730,348522,352406,356170,374830350,377743,383821,384588,384870,393045128,396122,401025,423246,423649,424825,427332,435448,438994,441540,45398,467452,467991,468199,470571,478417,486800595,487157278,487427819,490554437,490584352,490889179,490892474,494590065,495693282,4969218,506295719,518147482,52032,545744198,552760058,571478831,599483495,61315235,635814426,660873775,676057317,701869111,702135025,703656949,711092903,711450558,727883558,727883626,735046156,763873283,763890181,79052,799613071,808512986,823549678,83225,834587853,848650104,866748049,898317650,929260297,931056605,939202009,945469798,958307775,967959219,96962,973716045,98029";
my $agents = $age->prepare("select a_id,a_name,a_start,a_last,a_valuedays,a_realvaluedays,a_last_5p,a_totalhit from agent where a_id in ($ag)");


{
   $agents->execute();
   while (my $sresult = $agents->fetchrow_hashref())
   {
      my $aid=$sresult->{a_id};
      my $aname=$sresult->{a_name};
      my $atotal=$sresult->{a_totalhit};

      print $aname." -> ".$atotal."\n";

      open F,"iphone_csv_nodecay/processed_".$aid.".csv";
      while (<F>)
      {
        $lne=$_;
        $lne=~s/\n|\r//gmi;
        my($idx,$vle)=split(",",$lne);
        $idx=$idx*1;

        if ($total{$idx}<1) {$total{$idx};}
        $total{$idx}+=$vle;
        $simplenum = $vle/$atotal;
        $devi{$idx}.=$simplenum.":".$atotal.",";
      }
      close (F);
   }
   open F,">iphone_total_nodecay.csv";
   open G,">iphone_deviation_nodecay.csv";

   for ($j=1;$j<365*2;$j++)
   {
       chop($devi{$j});
       print F $j.",".$total{$j}."\n";
       print G $j.",".$devi{$j}."\n";
   }
   close(F);
   close(G);
}


